<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parma 2027 - Ultimate Layering Fix</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --parma-yellow: #ffd700;
        --parma-blue: #003399;
        --text-dark: #1d1d1f;
      }

      body {
        background-color: #f0f2f5;
        background-image: radial-gradient(
            at 10% 10%,
            hsla(227, 85%, 65%, 0.3) 0px,
            transparent 50%
          ),
          radial-gradient(
            at 90% 10%,
            hsla(50, 95%, 60%, 0.3) 0px,
            transparent 50%
          ),
          radial-gradient(
            at 90% 90%,
            hsla(227, 85%, 65%, 0.3) 0px,
            transparent 50%
          ),
          radial-gradient(
            at 10% 90%,
            hsla(50, 95%, 60%, 0.3) 0px,
            transparent 50%
          );
        font-family: "Poppins", sans-serif;
        margin: 0;
        height: 100vh;
        width: 100vw;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }

      .mac-window {
        position: relative;
        width: 95vw;
        height: 90vh;
        max-width: 1800px;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(50px);
        border: 1px solid rgba(255, 255, 255, 0.9);
        border-radius: 24px;
        box-shadow: 0 40px 80px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
        z-index: 1;
      }

      .window-toolbar {
        height: 44px;
        background: rgba(255, 255, 255, 0.5);
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        border-radius: 24px 24px 0 0;
        position: relative;
        z-index: 50; /* Toolbar sempre sopra */
      }
      .window-title {
        font-size: 0.8rem;
        color: #555;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .window-content {
        flex-grow: 1;
        position: relative;
        display: flex;
        flex-direction: column;
        width: 100%;
        overflow: hidden; /* Il contenuto principale non deve scrollare, lo fa il container interno */
      }

      /* HEADER POSIZIONATO ASSOLUTO - Sta "sotto" l'area di scroll visiva */
      .page-header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        padding-top: 30px;
        padding-bottom: 10px;
        text-align: center;
        z-index: 1; /* Livello basso */
        padding-left: 20px;
        padding-right: 20px;
        pointer-events: auto; /* Cliccabile */
      }
      h1 {
        margin: 0;
        font-weight: 800;
        color: var(--parma-blue);
        text-transform: uppercase;
        font-size: clamp(1.5rem, 3vw, 3rem);
        line-height: 1.1;
      }

      p {
        color: #444;
        font-size: clamp(0.8rem, 1vw, 1rem);
        margin-top: 10px;
        font-weight: 400;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
        line-height: 1.5;
      }

      .scroll-indicator-box {
        position: relative;
        z-index: 10; /* Assicura che il pulsante sia cliccabile */
      }

      /* CONTAINER A TUTTA ALTEZZA */
      .scroll-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        overflow-x: auto;
        overflow-y: visible; /* Fondamentale */

        /* Padding massiccio per spingere la timeline sotto l'header */
        padding-top: 250px;
        padding-bottom: 100px;

        z-index: 2; /* Sta SOPRA l'header */
        pointer-events: none; /* Lascia passare i click attraverso lo spazio vuoto */

        scroll-snap-type: x mandatory;
        scroll-behavior: smooth;
      }

      /* Riattiviamo i click sugli oggetti interni */
      .universe {
        pointer-events: auto;
        display: flex;
        align-items: center;
        position: relative;
        height: 100%;
        width: max-content;
        box-sizing: border-box;
        padding-left: 600px;
        padding-right: 50vw;
      }

      /* MEDIA QUERY MOBILE */
      @media (max-width: 768px) {
        .scroll-container {
          padding-top: 280px; /* Ancora più spazio su mobile */
          padding-bottom: 120px;
        }
        .universe {
          padding-left: calc(50vw - 160px);
          padding-right: calc(50vw - 160px);
        }
      }

      .scroll-container::-webkit-scrollbar {
        height: 12px;
      }
      .scroll-container::-webkit-scrollbar-thumb {
        background-color: var(--parma-blue);
        border-radius: 10px;
        border: 3px solid white;
        cursor: pointer;
        pointer-events: auto;
      }
      .scroll-container::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
        pointer-events: auto;
      }

      .timeline-line {
        position: absolute;
        left: 0;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        height: 4px;
        z-index: 0;
        background: linear-gradient(
          90deg,
          rgba(0, 51, 153, 0) 0%,
          rgba(0, 51, 153, 0.25) 5%,
          rgba(0, 51, 153, 0.25) 95%,
          rgba(0, 51, 153, 0) 100%
        );
      }

      /* SUN SYSTEM */
      .sun-system {
        position: relative;
        width: 320px;
        height: 500px;
        scroll-snap-align: center;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 5;
        transition: transform 0.3s ease;
        transform-style: preserve-3d;
      }

      /* Sale sopra a tutto quando attivo */
      .sun-system.active {
        z-index: 99999 !important;
      }

      @media (max-height: 800px) {
        .sun-system {
          transform: scale(0.8);
        }
      }
      @media (max-height: 600px) {
        .sun-system {
          transform: scale(0.65);
        }
      }

      .core-dot {
        position: absolute;
        width: 36px;
        height: 36px;
        background: var(--parma-yellow);
        border: 6px solid white;
        border-radius: 50%;
        box-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
        z-index: 10;
        cursor: pointer;
        transition: all 0.4s ease;
      }

      .label-event {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, 45px);
        background: white;
        padding: 10px 20px;
        border-radius: 20px;
        font-weight: 800;
        font-size: 0.85rem;
        color: var(--parma-blue);
        text-transform: uppercase;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        pointer-events: none;
        z-index: 11;
        text-align: center;
        width: 220px;
        line-height: 1.2;
      }
      .event-date {
        display: block;
        font-weight: 500;
        font-size: 0.75rem;
        color: #666;
        margin-top: 2px;
        text-transform: none;
      }

      .sat-wrapper {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        z-index: 5;
        transform: translate(-50%, -50%);
        transition: transform 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .sun-system.active .sat-wrapper {
        transform: translate(
          calc(var(--pos-x) - 50%),
          calc(var(--pos-y) - 50%)
        );
        pointer-events: auto;
      }

      .sat-wrapper:has(.satellite-body.active) {
        z-index: 100 !important;
      }

      .satellite-body {
        flex: 0 0 auto;
        width: 54px;
        height: 54px;
        min-width: 54px;
        min-height: 54px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        border: 2px solid white;
        border-radius: 50%;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        cursor: pointer;
        transform: scale(0.5);
        opacity: 0;
        transition: all 0.3s ease 0.1s;
      }

      .sun-system.active .satellite-body {
        opacity: 1;
        transform: scale(1);
      }
      .satellite-body:hover,
      .satellite-body.active {
        transform: scale(1.15);
        border-color: var(--parma-yellow);
        box-shadow: 0 0 15px var(--parma-yellow);
      }

      .connector {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 2px;
        height: 0;
        background: var(--parma-blue);
        opacity: 0.15;
        transform-origin: top center;
        transition: height 0.5s ease;
        pointer-events: none;
        transform: rotate(var(--angle));
        z-index: 1;
      }

      .sun-system.active .connector {
        height: 180px;
      }

      .glass-card {
        position: absolute;
        width: 400px;
        min-width: 400px;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(40px);
        border: 1px solid white;
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.25);
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        z-index: 9999;
        text-align: left;
        border-left: 5px solid transparent;
        display: flex;
        flex-direction: column;
        max-height: 450px;
      }

      .border-insta {
        border-left-color: #e1306c !important;
      }
      .border-tiktok {
        border-left-color: #000 !important;
      }
      .border-web {
        border-left-color: var(--parma-blue) !important;
      }
      .border-press {
        border-left-color: #555 !important;
      }
      .border-fb {
        border-left-color: #1877f2 !important;
      }
      .border-linkedin {
        border-left-color: #0077b5 !important;
      }

      .satellite-body.active .glass-card {
        opacity: 1;
        pointer-events: auto;
      }

      .card-opens-down {
        top: 65px;
        left: 50%;
        transform: translateX(-50%) translateY(-20px);
      }
      .satellite-body.active .card-opens-down {
        transform: translateX(-50%) translateY(0);
      }

      .card-opens-up {
        bottom: 65px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
      }
      .satellite-body.active .card-opens-up {
        transform: translateX(-50%) translateY(0);
      }

      @media (max-width: 1100px), (max-height: 850px) {
        .glass-card {
          width: 85vw !important;
          min-width: 280px !important;
          max-width: 400px !important;
          max-height: 60vh !important;
          top: 50% !important;
          left: 50% !important;
          bottom: auto !important;
          transform: translate(
            calc(var(--pos-x) * -1 - 50%),
            calc(var(--pos-y) * -1 - 50%)
          ) !important;
          margin: 0 !important;
        }
        .card-desc {
          max-height: 200px;
          overflow-y: auto;
        }
      }

      .card-header {
        display: inline-flex;
        align-items: center;
        margin-bottom: 12px;
        font-size: 0.75rem;
        font-weight: 700;
        color: #333;
        text-transform: uppercase;
        letter-spacing: 1px;
        flex-shrink: 0;
        background: #f0f2f5;
        padding: 6px 14px;
        border-radius: 30px;
        align-self: flex-start;
      }
      .icon-sm {
        font-size: 1.1rem;
        margin-right: 8px;
      }
      .card-title {
        font-weight: 800;
        font-size: 1.5rem;
        color: var(--parma-blue);
        line-height: 1.1;
        margin-bottom: 12px;
        flex-shrink: 0;
      }
      .card-desc {
        font-size: 1rem;
        color: #444;
        line-height: 1.6;
        margin-bottom: 15px;
        overflow-y: auto;
        padding-right: 10px;
        flex-grow: 1;
      }
      .card-desc b {
        color: var(--parma-blue);
      }
      .card-stats {
        border-top: 1px solid #eee;
        padding-top: 12px;
        font-size: 0.9rem;
        color: #333;
        font-weight: 600;
        flex-shrink: 0;
        margin-top: 10px;
      }
      .emitter-label {
        display: block;
        font-size: 0.65rem;
        color: #999;
        text-transform: uppercase;
        margin-bottom: 2px;
      }

      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: var(--parma-blue);
        font-weight: 700;
        z-index: 1000;
      }

      .tutorial-hint {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, calc(-100% - 25px));
        display: flex;
        flex-direction: column;
        align-items: center;
        pointer-events: none;
        z-index: 2000;
        transition: opacity 0.5s;
        animation: floatHint 2s infinite ease-in-out;
      }
      @keyframes floatHint {
        0%,
        100% {
          transform: translate(-50%, calc(-100% - 25px));
        }
        50% {
          transform: translate(-50%, calc(-100% - 32px));
        }
      }
    </style>
  </head>
  <body>
    <div class="mac-window">
      <div class="window-toolbar">
        <div class="window-title">Dashboard Strategica 2027</div>
      </div>
      <div class="window-content">
        <div class="page-header">
          <h1>PARMA 2027</h1>
          <p>
            Una prima prova di pianificazione di contenuti a partire dai
            prossimi eventi. Clicca su evento e su ogni icona per vedere le
            varie azioni di comunicazione da sviluppare.
          </p>
          <div
            class="scroll-indicator-box"
            id="scroll-btn"
            style="
              cursor: pointer;
              display: inline-flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
              margin-top: 15px;
              padding: 10px 24px;
              background: rgba(255, 255, 255, 0.5);
              backdrop-filter: blur(10px);
              border: 1px solid rgba(255, 255, 255, 0.9);
              border-radius: 50px;
              box-shadow: 0 4px 15px rgba(0, 51, 153, 0.05);
              color: var(--parma-blue);
              font-size: 0.8rem;
              font-weight: 700;
              text-transform: uppercase;
              letter-spacing: 1px;
              animation: bounce 2s infinite;
            "
          >
            SCORRI LA TIMELINE ➜
          </div>
        </div>
        <div class="scroll-container">
          <div class="universe" id="universe-container">
            <div id="loading">Caricamento dati...</div>
            <div class="timeline-line"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const sheetUrl =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vS6z7Q4duCgtH98HKCmd4P0dkQ-sOQBR-d5GxL3HkSeJwuYdkq2j80vL5KIPay-4hlkDQIMD3OA8lSJ/pub?gid=0&single=true&output=csv";

      async function init() {
        try {
          const response = await fetch(sheetUrl);
          const text = await response.text();
          const data = parseCSV(text);
          renderTimeline(data);
        } catch (error) {
          console.error("Fetch Error:", error);
          document.getElementById("loading").innerText =
            "Errore durante il caricamento dei dati.";
        }
      }

      function parseCSV(csvText) {
        const rows = csvText.split("\n").slice(1);
        const eventsMap = {};
        rows.forEach((row) => {
          const cols = row
            .split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
            .map((c) => c.trim().replace(/^"|"$/g, ""));
          if (cols.length < 6) return;
          const [evt, chan, tit, desc, emit, icon] = cols;
          if (!evt) return;
          if (!eventsMap[evt]) {
            const parts = evt.split("|");
            let dTit = parts[0].trim();
            if (parts.length > 1)
              dTit += `<span class="event-date">${parts[1].trim()}</span>`;
            eventsMap[evt] = { eventTitle: dTit, nodes: [] };
          }
          let bCls = "border-web";
          const c = chan.toLowerCase();
          if (c.includes("instagram")) bCls = "border-insta";
          else if (c.includes("tiktok")) bCls = "border-tiktok";
          else if (c.includes("facebook")) bCls = "border-fb";
          else if (c.includes("linkedin")) bCls = "border-linkedin";
          else if (c.includes("stampa")) bCls = "border-press";
          eventsMap[evt].nodes.push({
            chan,
            icon,
            tit,
            text: desc,
            emit,
            bCls,
          });
        });
        return Object.values(eventsMap);
      }

      function renderTimeline(timelineData) {
        const container = document.getElementById("universe-container");
        document.getElementById("loading").style.display = "none";
        container.querySelectorAll(".sun-system").forEach((el) => el.remove());

        timelineData.forEach((event, index) => {
          const system = document.createElement("div");
          system.className = "sun-system";
          let nodesHTML = "";
          let linesHTML = "";
          let hintHTML =
            index === 0
              ? `<div class="tutorial-hint" id="first-hint"><div class="hint-text">Clicca per scoprire</div><div style="width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:8px solid white;"></div></div>`
              : "";

          const total = event.nodes.length;
          const radius = 180;

          event.nodes.forEach((node, i) => {
            const angleDegree = i * (360 / total) - 90;
            const angleRad = angleDegree * (Math.PI / 180);
            const tx = Math.round(Math.cos(angleRad) * radius);
            const ty = Math.round(Math.sin(angleRad) * radius);

            const isTopHalf = angleDegree >= -180 && angleDegree < 0;
            const cCls = isTopHalf ? "card-opens-down" : "card-opens-up";

            linesHTML += `<div class="connector" style="--angle: ${
              angleDegree + 270
            }deg"></div>`;

            nodesHTML += `
                        <div class="sat-wrapper" style="--pos-x: ${tx}px; --pos-y: ${ty}px">
                            <div class="satellite-body">
                                ${node.icon}
                                <div class="glass-card ${cCls} ${node.bCls}">
                                    <div class="card-header"><span class="icon-sm">${node.icon}</span> ${node.chan}</div>
                                    <div class="card-title">${node.tit}</div>
                                    <div class="card-desc">${node.text}</div>
                                    <div class="card-stats"><span class="emitter-label">PUBBLICATO DA:</span>${node.emit}</div>
                                </div>
                            </div>
                        </div>`;
          });

          system.innerHTML = `<div class="core-dot"></div>${hintHTML}<div class="label-event">${event.eventTitle}</div>${linesHTML}${nodesHTML}`;
          container.appendChild(system);
        });
        attachInteractions();
      }

      function attachInteractions() {
        document.getElementById("scroll-btn").addEventListener("click", () => {
          const scrollAmount = window.innerWidth < 768 ? 260 : 320;
          document
            .querySelector(".scroll-container")
            .scrollBy({ left: scrollAmount, behavior: "smooth" });
        });

        const systems = document.querySelectorAll(".sun-system");
        systems.forEach((system) => {
          system.querySelector(".core-dot").addEventListener("click", (e) => {
            e.stopPropagation();
            if (document.getElementById("first-hint"))
              document.getElementById("first-hint").style.opacity = "0";
            systems.forEach((s) => {
              if (s !== system) {
                s.classList.remove("active");
                s.querySelectorAll(".satellite-body").forEach((sat) =>
                  sat.classList.remove("active")
                );
              }
            });
            system.classList.toggle("active");
          });
          system.querySelectorAll(".satellite-body").forEach((sat) => {
            sat.addEventListener("click", (e) => {
              e.stopPropagation();
              if (sat.classList.contains("active"))
                sat.classList.remove("active");
              else {
                system
                  .querySelectorAll(".satellite-body")
                  .forEach((sibling) => sibling.classList.remove("active"));
                sat.classList.add("active");
              }
            });
          });
        });
        document.addEventListener("click", (e) => {
          const activeCard = document.querySelector(".satellite-body.active");
          if (activeCard) activeCard.classList.remove("active");
          else if (!e.target.closest(".core-dot"))
            document
              .querySelectorAll(".sun-system.active")
              .forEach((s) => s.classList.remove("active"));
        });
      }
      init();
    </script>
  </body>
</html>
